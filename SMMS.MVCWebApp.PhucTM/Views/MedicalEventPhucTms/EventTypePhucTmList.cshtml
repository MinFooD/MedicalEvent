<h1>EventTypes - Call RESTful API from Client via jQuery.Ajax</h1>

<div class="mb-3">
    <button type="button" class="btn btn-primary" onclick="addNew();">Add</button>
</div>

<table class="table table-bordered">
    <thead>
        <tr>
            <th>TypeName</th>
            <th>Description</th>
            <th>SeverityLevel</th>
            <th></th>
        </tr>
    </thead>
    <tbody class="tblBody"></tbody>
</table>

<!-- Modal Add/Edit -->
<div class="modal" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            @using (Html.BeginForm(null, null, FormMethod.Post, new { name = "frmEvent", id = "frmEvent" }))
            {
                @Html.AntiForgeryToken()
                <div class="modal-header">
                    <h5 class="modal-title" id="eventModalLabel">EventTypes</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="form-group row">
                        <div class="col-md-4">
                            <label>TypeName</label>
                            <input type="hidden" id="eventTypePhucTmid" name="eventTypePhucTmid" value="0" />
                            <input type="text" id="typeName" name="typeName" class="form-control" />
                        </div>
                        <div class="col-md-4">
                            <label>Description</label>
                            <input type="text" id="description" name="description" class="form-control" />
                        </div>
                        <div class="col-md-4">
                            <label>Severity Level</label>
                            <input type="text" id="severityLevel" name="severityLevel" class="form-control" />
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="btSave" type="button" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            }
        </div>
    </div>
</div>

<!-- Modal Detail -->
<div class="modal fade" id="eventTypeDetailModal" tabindex="-1" aria-labelledby="eventTypeDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Event Type Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="eventTypeDetailBody"></div>
            <div class="modal-footer" id="eventTypeDetailFooter"></div>
        </div>
    </div>
</div>

@section scripts {
    <script type="text/javascript">
        $(document).ready(function () {
            loadData();

            $("#btSave").click(function () {
                const isEdit = $(this).text().toLowerCase() === "update";
                const method = isEdit ? 'PUT' : 'POST';

                $.ajax({
                    type: method,
                    url: 'https://localhost:7071/api/EventTypePhucTms',
                    contentType: "application/json;charset=utf-8",
                    data: JSON.stringify({
                        eventTypePhucTmid: parseInt($("#eventTypePhucTmid").val()),
                        typeName: $("#typeName").val(),
                        description: $("#description").val(),
                        severityLevel: $("#severityLevel").val()
                    }),
                    success: function (result) {
                        if (result > 0) {
                            $('#eventModal').modal('hide');
                            loadData();
                        }
                    },
                    error: function (xhr) {
                        alert("Error: " + xhr.responseText);
                    }
                });
            });
        });

        function loadData() {
            $.ajax({
                url: 'https://localhost:7071/api/EventTypePhucTms',
                type: "GET",
                contentType: "application/json;charset=utf-8",
                success: function (result) {
                    let html = '';
                    $.each(result, function (i, item) {
                        html += '<tr>';
                        html += '<td>' + item.typeName + '</td>';
                        html += '<td>' + item.description + '</td>';
                        html += '<td>' + item.severityLevel + '</td>';
                        html += '<td> <button type="button" class="btn btn-primary" onclick=viewDetail("' + item.eventTypePhucTmid + '")>Detail</button> </td>';
                        html += '</tr>';
                    });
                    $(".tblBody").html(html);
                            $.each(result, function (i, item) {
            console.log("item = ", item); // 👈 xem có key eventTypePhucTmid không
        });
                },
                error: function (xhr) {
                    alert("Failed to load data: " + xhr.statusText);
                }
            });
        }

        function addNew() {
            $("#frmEvent")[0].reset();
            $("#eventTypePhucTmid").val(0);
            $("#btSave").text("Save");
            $("#eventModalLabel").text("Add New Event Type");
            $('#eventModal').modal('show');
        }

        function viewDetail(id) {
            $.ajax({
                url: 'https://localhost:7071/api/EventTypePhucTms/' + id,
                type: "GET",
                contentType: "application/json;charset=utf-8",
                success: function (result) {
                    let detail = `
                        <p><strong>Type Name:</strong> ${result.typeName}</p>
                        <p><strong>Description:</strong> ${result.description}</p>
                        <p><strong>Severity Level:</strong> ${result.severityLevel}</p>
                    `;
                    $('#eventTypeDetailBody').html(detail);
                    $('#eventTypeDetailFooter').html(`
                        <button class="btn btn-warning" onclick="editEventType(${result.eventTypePhucTmid})">Edit</button>
                        <button class="btn btn-danger" onclick="deleteEventType(${result.eventTypePhucTmid})">Delete</button>
                        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    `);
                    $('#eventTypeDetailModal').modal('show');
                },
                error: function (xhr) {
                    alert("Failed to get details: " + xhr.statusText);
                }
            });
        }

        function editEventType(id) {
            $.ajax({
                url: 'https://localhost:7071/api/EventTypePhucTms/' + id,
                type: "GET",
                contentType: "application/json;charset=utf-8",
                success: function (result) {
                    $("#eventTypePhucTmid").val(result.eventTypePhucTmid);
                    $("#typeName").val(result.typeName);
                    $("#description").val(result.description);
                    $("#severityLevel").val(result.severityLevel);

                    $('#eventTypeDetailModal').modal('hide');
                    $("#btSave").text("Update");
                    $('#eventModal').modal('show');
                },
                error: function (xhr) {
                    alert("Error loading for edit: " + xhr.statusText);
                }
            });
        }

        function deleteEventType(id) {
            if (confirm("Are you sure you want to delete this event type?")) {
                $.ajax({
                    url: 'https://localhost:7071/api/EventTypePhucTms/' + id,
                    type: 'DELETE',
                    success: function () {
                        alert("Deleted successfully.");
                        $('#eventTypeDetailModal').modal('hide');
                        loadData();
                    },
                    error: function (xhr) {
                        alert("Error deleting: " + xhr.responseText);
                    }
                });
            }
        }
    </script>
}
